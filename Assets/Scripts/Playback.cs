
using UdonSharp;
using UnityEngine;
using VRC.SDKBase;
using VRC.Udon;

public class Playback : UdonSharpBehaviour
{
    private float[] history;
    private Pourer pourer;
    private Fluids2D fluids2d;
    private int row = 0;
    private float triggerInputTime;
    private float currentTime;


    private int DT = 0;
    private int COORD_X = 1;
    private int COORD_Y = 2;
    private int PREV_COORD_X = 3;
    private int PREV_COORD_Y = 4;
    private int DELTA_X = 5;
    private int DELTA_Y = 6;
    private int ROW_SIZE = 7;

    void Start()
    {
        pourer = GetComponent<Pourer>();
        fluids2d = GetComponent<Fluids2D>();

        // dt, coordX, coordY, prevCoordX, prevCoordY, deltaX, deltaY
        // all in one-dimensional array because VRChat doesn't support 2D arrays
        history = new float[] {
0f, 0.4261261261261261f, 0.5529622980251346f, 0.4252252252252252f, 0.5493716337522442f, 0.000897666068222612f, 0.0035906642728904536f,
0.015f, 0.4261261261261261f, 0.5601436265709157f, 0.4261261261261261f, 0.5529622980251346f, 0f, 0.007181328545781018f,
0.016f, 0.42702702702702705f, 0.5682226211849193f, 0.4261261261261261f, 0.5601436265709157f, 0.0008976660682226674f, 0.008078994614003632f,
0.016f, 0.42792792792792794f, 0.5771992818671454f, 0.42702702702702705f, 0.5682226211849193f, 0.000897666068222612f, 0.008976660682226134f,
0.017f, 0.4297297297297297f, 0.5879712746858169f, 0.42792792792792794f, 0.5771992818671454f, 0.001795332136445224f, 0.010771992818671472f,
0.018f, 0.4315315315315315f, 0.5969479353680431f, 0.4297297297297297f, 0.5879712746858169f, 0.001795332136445224f, 0.008976660682226245f,
0.016f, 0.43243243243243246f, 0.6023339317773788f, 0.4315315315315315f, 0.5969479353680431f, 0.0008976660682226674f, 0.0053859964093356805f,
0.022f, 0.43333333333333335f, 0.606822262118492f, 0.43243243243243246f, 0.6023339317773788f, 0.000897666068222612f, 0.004488330341113178f,
0.011f, 0.43333333333333335f, 0.6077199281867145f, 0.43333333333333335f, 0.606822262118492f, 0f, 0.0008976660682225024f,
0.017f, 0.43333333333333335f, 0.6086175942549372f, 0.43333333333333335f, 0.6077199281867145f, 0f, 0.0008976660682227244f,
0.402f, 0.42162162162162165f, 0.5403949730700179f, 0.4198198198198198f, 0.5368043087971275f, 0.0017953321364452793f, 0.0035906642728904536f,
0.016f, 0.4243243243243243f, 0.5493716337522442f, 0.42162162162162165f, 0.5403949730700179f, 0.0026929982046678363f, 0.008976660682226245f,
0.016f, 0.42702702702702705f, 0.5592459605026929f, 0.4243243243243243f, 0.5493716337522442f, 0.0026929982046678914f, 0.009874326750448748f,
0.017f, 0.42882882882882883f, 0.570915619389587f, 0.42702702702702705f, 0.5592459605026929f, 0.001795332136445224f, 0.011669658886894085f,
0.016f, 0.4297297297297297f, 0.5789946140035906f, 0.42882882882882883f, 0.570915619389587f, 0.000897666068222612f, 0.008078994614003632f,
0.017f, 0.4306306306306306f, 0.5834829443447038f, 0.4297297297297297f, 0.5789946140035906f, 0.000897666068222612f, 0.004488330341113178f,
0.016f, 0.4306306306306306f, 0.5861759425493716f, 0.4306306306306306f, 0.5834829443447038f, 0f, 0.002692998204667729f,
0.418f, 0.4072072072072072f, 0.526032315978456f, 0.4063063063063063f, 0.526032315978456f, 0.000897666068222612f, 0f,
0.017f, 0.409009009009009f, 0.5305206463195691f, 0.4072072072072072f, 0.526032315978456f, 0.001795332136445224f, 0.004488330341113067f,
0.016f, 0.4126126126126126f, 0.5377019748653501f, 0.409009009009009f, 0.5305206463195691f, 0.0035906642728905035f, 0.007181328545781018f,
0.016f, 0.4153153153153153f, 0.5457809694793536f, 0.4126126126126126f, 0.5377019748653501f, 0.0026929982046678363f, 0.00807899461400352f,
0.018f, 0.418018018018018f, 0.55475763016158f, 0.4153153153153153f, 0.5457809694793536f, 0.0026929982046678914f, 0.008976660682226356f,
0.016f, 0.4198198198198198f, 0.5619389587073609f, 0.418018018018018f, 0.55475763016158f, 0.001795332136445224f, 0.007181328545780907f,
0.017f, 0.42162162162162165f, 0.5682226211849193f, 0.4198198198198198f, 0.5619389587073609f, 0.0017953321364452793f, 0.006283662477558405f,
0.017f, 0.42252252252252254f, 0.5727109515260322f, 0.42162162162162165f, 0.5682226211849193f, 0.000897666068222612f, 0.004488330341112956f,
0.017f, 0.42252252252252254f, 0.5745062836624776f, 0.42252252252252254f, 0.5727109515260322f, 0f, 0.0017953321364453378f,
0.015f, 0.42252252252252254f, 0.5754039497307002f, 0.42252252252252254f, 0.5745062836624776f, 0f, 0.0008976660682226134f,
0.483f, 0.3783783783783784f, 0.492818671454219f, 0.372972972972973f, 0.49192100538599637f, 0.005385996409335727f, 0.0008976660682226134f,
0.017f, 0.3891891891891892f, 0.4946140035906643f, 0.3783783783783784f, 0.492818671454219f, 0.010771992818671455f, 0.0017953321364453378f,
0.016f, 0.4018018018018018f, 0.49640933572710955f, 0.3891891891891892f, 0.4946140035906643f, 0.01256732495511668f, 0.0017953321364452268f,
0.017f, 0.418018018018018f, 0.49640933572710955f, 0.4018018018018018f, 0.49640933572710955f, 0.016157989228007184f, 0f,
0.017f, 0.43333333333333335f, 0.49640933572710955f, 0.418018018018018f, 0.49640933572710955f, 0.01526032315978457f, 0f,
0.017f, 0.44594594594594594f, 0.49640933572710955f, 0.43333333333333335f, 0.49640933572710955f, 0.01256732495511668f, 0f,
0.016f, 0.45495495495495497f, 0.49640933572710955f, 0.44594594594594594f, 0.49640933572710955f, 0.008976660682226231f, 0f,
0.017f, 0.45675675675675675f, 0.49640933572710955f, 0.45495495495495497f, 0.49640933572710955f, 0.001795332136445224f, 0f,
0.351f, 0.39369369369369367f, 0.49102333931777375f, 0.390990990990991f, 0.49102333931777375f, 0.0026929982046678363f, 0f,
0.017f, 0.4018018018018018f, 0.49012567324955114f, 0.39369369369369367f, 0.49102333931777375f, 0.00807899461400362f, -0.0008976660682226134f,
0.017f, 0.4126126126126126f, 0.49012567324955114f, 0.4018018018018018f, 0.49012567324955114f, 0.010771992818671455f, 0f,
0.017f, 0.4306306306306306f, 0.49012567324955114f, 0.4126126126126126f, 0.49012567324955114f, 0.017953321364452407f, 0f,
0.016f, 0.44684684684684683f, 0.49012567324955114f, 0.4306306306306306f, 0.49012567324955114f, 0.016157989228007184f, 0f,
0.016f, 0.4603603603603604f, 0.49012567324955114f, 0.44684684684684683f, 0.49012567324955114f, 0.013464991023339347f, 0f,
0.017f, 0.4648648648648649f, 0.49012567324955114f, 0.4603603603603604f, 0.49012567324955114f, 0.004488330341113116f, 0f,
0.317f, 0.4018018018018018f, 0.48922800718132853f, 0.4018018018018018f, 0.4883303411131059f, 0f, 0.0008976660682226134f,
0.017f, 0.4036036036036036f, 0.48922800718132853f, 0.4018018018018018f, 0.48922800718132853f, 0.001795332136445224f, 0f,
0.017f, 0.4072072072072072f, 0.48922800718132853f, 0.4036036036036036f, 0.48922800718132853f, 0.0035906642728905035f, 0f,
0.016f, 0.4135135135135135f, 0.48922800718132853f, 0.4072072072072072f, 0.48922800718132853f, 0.00628366247755834f, 0f,
0.017f, 0.42702702702702705f, 0.48922800718132853f, 0.4135135135135135f, 0.48922800718132853f, 0.013464991023339347f, 0f,
0.017f, 0.43873873873873875f, 0.48922800718132853f, 0.42702702702702705f, 0.48922800718132853f, 0.011669658886894068f, 0f,
0.016f, 0.45045045045045046f, 0.48922800718132853f, 0.43873873873873875f, 0.48922800718132853f, 0.011669658886894068f, 0f,
0.017f, 0.45585585585585586f, 0.48922800718132853f, 0.45045045045045046f, 0.48922800718132853f, 0.005385996409335727f, 0f,
0.016f, 0.45765765765765765f, 0.48922800718132853f, 0.45585585585585586f, 0.48922800718132853f, 0.001795332136445224f, 0f,
0.567f, 0.41621621621621624f, 0.46499102333931774f, 0.41621621621621624f, 0.47037701974865354f, 0f, -0.0053859964093357915f,
0.017f, 0.41621621621621624f, 0.4569120287253142f, 0.41621621621621624f, 0.46499102333931774f, 0f, -0.00807899461400352f,
0.017f, 0.41621621621621624f, 0.44703770197486536f, 0.41621621621621624f, 0.4569120287253142f, 0f, -0.009874326750448859f,
0.017f, 0.41621621621621624f, 0.43895870736086173f, 0.41621621621621624f, 0.44703770197486536f, 0f, -0.008078994614003632f,
0.016f, 0.41621621621621624f, 0.43357271095152605f, 0.41621621621621624f, 0.43895870736086173f, 0f, -0.0053859964093356805f,
0.016f, 0.41621621621621624f, 0.4290843806104129f, 0.41621621621621624f, 0.43357271095152605f, 0f, -0.004488330341113178f,
0.017f, 0.41621621621621624f, 0.42639138240574503f, 0.41621621621621624f, 0.4290843806104129f, 0f, -0.0026929982046678402f,
0.352f, 0.4306306306306306f, 0.48473967684021546f, 0.4306306306306306f, 0.4856373429084381f, 0f, -0.0008976660682226134f,
0.016f, 0.4306306306306306f, 0.4802513464991023f, 0.4306306306306306f, 0.48473967684021546f, 0f, -0.004488330341113178f,
0.016f, 0.42882882882882883f, 0.47037701974865354f, 0.4306306306306306f, 0.4802513464991023f, -0.001795332136445224f, -0.009874326750448748f,
0.017f, 0.42702702702702705f, 0.45780969479353684f, 0.42882882882882883f, 0.47037701974865354f, -0.001795332136445224f, -0.012567324955116699f,
0.016f, 0.4243243243243243f, 0.44614003590664275f, 0.42702702702702705f, 0.45780969479353684f, -0.0026929982046678914f, -0.011669658886894085f,
0.016f, 0.42342342342342343f, 0.43985637342908435f, 0.4243243243243243f, 0.44614003590664275f, -0.000897666068222612f, -0.006283662477558405f,
0.017f, 0.42342342342342343f, 0.4362657091561939f, 0.42342342342342343f, 0.43985637342908435f, 0f, -0.0035906642728904536f,
0.351f, 0.43423423423423424f, 0.4865350089766607f, 0.43423423423423424f, 0.49102333931777375f, 0f, -0.004488330341113067f,
0.017f, 0.43333333333333335f, 0.47755834829443444f, 0.43423423423423424f, 0.4865350089766607f, -0.000897666068222612f, -0.008976660682226245f,
0.016f, 0.4315315315315315f, 0.46588868940754036f, 0.43333333333333335f, 0.47755834829443444f, -0.0017953321364452793f, -0.011669658886894085f,
0.017f, 0.4297297297297297f, 0.45242369838420105f, 0.4315315315315315f, 0.46588868940754036f, -0.001795332136445224f, -0.013464991023339312f,
0.017f, 0.4297297297297297f, 0.44614003590664275f, 0.4297297297297297f, 0.45242369838420105f, 0f, -0.006283662477558294f,
0.016f, 0.4297297297297297f, 0.4443447037701975f, 0.4297297297297297f, 0.44614003590664275f, 0f, -0.0017953321364452268f,
0.45f, 0.44954954954954957f, 0.5053859964093357f, 0.45045045045045046f, 0.5053859964093357f, -0.000897666068222612f, 0f,
0.016f, 0.44594594594594594f, 0.5053859964093357f, 0.44954954954954957f, 0.5053859964093357f, -0.0035906642728905035f, 0f,
0.017f, 0.43963963963963965f, 0.5053859964093357f, 0.44594594594594594f, 0.5053859964093357f, -0.00628366247755834f, 0f,
0.017f, 0.4297297297297297f, 0.5053859964093357f, 0.43963963963963965f, 0.5053859964093357f, -0.009874326750448843f, 0f,
0.017f, 0.4135135135135135f, 0.5062836624775584f, 0.4297297297297297f, 0.5053859964093357f, -0.016157989228007184f, 0.0008976660682227244f,
0.016f, 0.4f, 0.5080789946140036f, 0.4135135135135135f, 0.5062836624775584f, -0.013464991023339291f, 0.0017953321364452268f,
0.016f, 0.3855855855855856f, 0.5089766606822261f, 0.4f, 0.5080789946140036f, -0.014362657091561959f, 0.0008976660682225024f,
0.017f, 0.3801801801801802f, 0.5098743267504489f, 0.3855855855855856f, 0.5089766606822261f, -0.005385996409335727f, 0.0008976660682227244f,
0.016f, 0.3792792792792793f, 0.5098743267504489f, 0.3801801801801802f, 0.5098743267504489f, -0.000897666068222612f, 0f,
0.303f, 0.436036036036036f, 0.5080789946140036f, 0.43783783783783786f, 0.5080789946140036f, -0.0017953321364452793f, 0f,
0.017f, 0.4297297297297297f, 0.5089766606822261f, 0.436036036036036f, 0.5080789946140036f, -0.00628366247755834f, 0.0008976660682225024f,
0.015f, 0.42162162162162165f, 0.5098743267504489f, 0.4297297297297297f, 0.5089766606822261f, -0.008078994614003564f, 0.0008976660682227244f,
0.017f, 0.41081081081081083f, 0.5116696588868941f, 0.42162162162162165f, 0.5098743267504489f, -0.010771992818671455f, 0.0017953321364452268f,
0.016f, 0.4f, 0.5134649910233393f, 0.41081081081081083f, 0.5116696588868941f, -0.010771992818671455f, 0.0017953321364452268f,
0.017f, 0.3900900900900901f, 0.5152603231597845f, 0.4f, 0.5134649910233393f, -0.009874326750448843f, 0.0017953321364452268f,
0.017f, 0.3837837837837838f, 0.5152603231597845f, 0.3900900900900901f, 0.5152603231597845f, -0.00628366247755834f, 0f,
0.017f, 0.3810810810810811f, 0.5161579892280073f, 0.3837837837837838f, 0.5152603231597845f, -0.0026929982046678914f, 0.0008976660682227244f,
0.334f, 0.42702702702702705f, 0.5134649910233393f, 0.42792792792792794f, 0.5134649910233393f, -0.000897666068222612f, 0f,
0.015f, 0.42342342342342343f, 0.5143626570915619f, 0.42702702702702705f, 0.5134649910233393f, -0.0035906642728905035f, 0.0008976660682226134f,
0.017f, 0.4153153153153153f, 0.5143626570915619f, 0.42342342342342343f, 0.5143626570915619f, -0.00807899461400362f, 0f,
0.017f, 0.40540540540540543f, 0.5152603231597845f, 0.4153153153153153f, 0.5143626570915619f, -0.009874326750448787f, 0.0008976660682226134f,
0.016f, 0.3963963963963964f, 0.5161579892280073f, 0.40540540540540543f, 0.5152603231597845f, -0.008976660682226231f, 0.0008976660682227244f,
0.017f, 0.3891891891891892f, 0.5161579892280073f, 0.3963963963963964f, 0.5161579892280073f, -0.0071813285457809515f, 0f,
0.016f, 0.3864864864864865f, 0.5170556552962298f, 0.3891891891891892f, 0.5161579892280073f, -0.0026929982046678914f, 0.0008976660682225024f
};

        row = 0;
        currentTime = 0f;
        triggerInputTime = history[row * ROW_SIZE + DT];
    }

    void Update () {
        float dt = Time.deltaTime;
        currentTime += dt;

        if (currentTime > triggerInputTime) {
            pourer.texcoord = new Vector2(history[row * ROW_SIZE + COORD_X], history[row * ROW_SIZE + COORD_Y]);
            pourer.prevTexcoord = new Vector2(history[row * ROW_SIZE + PREV_COORD_X], history[row * ROW_SIZE + PREV_COORD_Y]);
            pourer.delta = new Vector2(history[row * ROW_SIZE + DELTA_X], history[row * ROW_SIZE + DELTA_Y]);
            fluids2d.SplatPourer();

            row = (row + 1) % (history.Length / ROW_SIZE);
            float nextTriggerInputTime = history[row * ROW_SIZE + DT];
            triggerInputTime += nextTriggerInputTime;
        }
    }
}
